---
title: "International Migration"
author: "Bruno de Melo"
date: "5/3/2020"
output: html_document
---

# International Migration
Project goal is to analyse international migration based on data obtained on the UN and World Bank data sites.

Data set contains historical data on migration for the years 1990, 1995, 2005, 2015 and 2019. There are many ways these dataset can be slided and diced. We will focus on the top countries of destination and origin.
# Visualization of migration flows over time
# What makes the top 20 destination countries attractive
# Can we predict next country in the club, based on indicators?
# Cluster analysis on World Bank Income group

# Data set-up

```{r}
library(tidyverse)
library(readxl)
library(lubridate)
library(leaflet)
library(plotly)

install.packages("leaflet")
install.packages("plotly")





# Data loading and data frame wrangling

# Files location
link_1<-"https://raw.githubusercontent.com/bsvmelo/CUNY/master/FinalProject/undata1.csv"

link_2<-"https://raw.githubusercontent.com/bsvmelo/CUNY/master/FinalProject/ANNEX.csv"

link_3<- xxxxx

link_4<-"https://raw.githubusercontent.com/bsvmelo/CUNY/master/FinalProject/location1.csv"

link_5<-"https://raw.githubusercontent.com/bsvmelo/CUNY/master/FinalProject/population.csv"

#loading data frames

#Contains Destination and Origin information per year
dt_migr<-read_csv(link_1, col_names = FALSE, skip=14, guess_max = 1000, col_types = cols(.default = col_character()),  locale = locale(grouping_mark = ",")) %>% data.frame()
dt_migr1<-dt_migr
# year column set to do col_types = cols(.default = col_character()), glimpse(dt_migr,20)

#Contains UN Development groups and World Bank's Income group classifications of each country 
dt_annex<-read.csv(link_2,header=FALSE, sep=",", stringsAsFactors = FALSE, skip = 15) %>% data.frame()
dt_group1<-dt_annex

#Contains World Bank's indices dataset


#Contains latitute and longitude data for each country
dt_loc<-read_csv(link_4, col_names = TRUE, guess_max = 100, locale = locale(decimal_mark = ".")) %>% data.frame()

#Contains population data for each country
dt_pop<-read_csv(link_5, col_names = TRUE, guess_max = 100, locale = locale(grouping_mark = ",")) %>% data.frame()

```

# Destination and Origin data set
This is the main data set, it contains migration stock from several years for all countries in the world. It also contains info on some country classification.

```{r}
# inspecting data frame
head(dt_migr1,20)

# rows 1 and 2 are the headers, so let's manipulate these rows and transform them into headers
# Let's retain columns 1 to 6 from row 15 and columns 7 to 241 from row 16
dt_migr1[1,c(7:241)]<-dt_migr1[2,c(7:241)]
dt_migr1<-dt_migr1[-c(2),] 
# Renaming headers with row 1 values and removing first row
names(dt_migr1) <- unname(unlist(dt_migr1[1,]))
dt_migr1 <- dt_migr1[-1,]
# converting columns
dt_migr1<-type_convert(dt_migr1)
dt_migr1[,1]<-year(parse_date(as.character(dt_migr1[,1]),"%Y"))
# Renaming column 3, column 6
dt_migr1<-rename(dt_migr1,Destination=names(dt_migr1)[3])
dt_migr1<-rename(dt_migr1,TypeData=names(dt_migr1)[6])

#Dimension and quick visualization of data frame
dim(dt_migr1)
head(dt_migr1,20)

```

# UN Development groups and World Bank's Income group classifications of each country
This is an auxiliary data set that contains country classification by UN Development and World Bank's Income groups.

```{r}
# dt_group1

# inspecting data frame
head(dt_group1,10)
# row 1 is the header, so let's manipulate it transforming it the dataset header
names(dt_group1) <- unname(unlist(dt_group1[1,]))
dt_group1 <- dt_group1[-1,]
# Renaming column 2, column 5
dt_group1<-rename(dt_group1,Region=names(dt_group1)[2])
dt_group1<-rename(dt_group1,TypeData=names(dt_group1)[5])
#dt_group1<-type_convert(dt_group1)
#Dimension and quick visualization of data frame
dim(dt_group1)
head(dt_group1,20)
```

Cross reference is type factor but we need to convert to Logical

```{r}
dt_group1[,c(6:15)] <- ifelse(dt_group1[,c(6:15)] == "Y", TRUE, FALSE)
dt_group1<-type_convert(dt_group1)
```



# UN and World Bank Classifications
There are several classifications listed in the data set. They are defined in the first 20 or so rows. These are the classification / groups:

1: UN development group: More developed, Less developed, least developed and Less developed ex-least
2: World Bank Income groups: High-, Middle-, Upper-Middle-, Lower-Middle-, Low-, No Income
3: Geographic Regions: Africa, Asia, Europe, Latin America & the Caribbean, Northern America, and Oceania.
4: Sustainable Development Goal (SDG) 7 regions:Sub-Saharan Africa, Northern Africa and Western Asia, Central and Southern Asia, Eastern and South-Eastern Asia, Latin America and the Caribbean, Oceania, and Europe and Northern America. These regions are further divided into 22 geographic subregions.

Cross reference is done by classification #1, #2 and 3 above. This will be enhanced with adding these specific codes to countries.  We also need to classify all countries by #4, as this will help with data set containing migration data.

```{r}
# UN development group
un_grp<-data.frame(dt_migr1[c(3:6),c(3,5)])
#un_grp$CountryCode<-as.numeric(un_grp$CountryCode)
colnames(un_grp)<- c("UN Dev Group","UN Dev Code")

# WB development group
wb_income<-data.frame(dt_group1[c(8:13),c(2,4)])
#wb_income$CountryCode<-as.integer(wb_income$CountryCode)
colnames(wb_income)<- c("WB Income","WB Inc Code")
# Geographic Regions
geo_regions<-data.frame(dt_group1[c(15:20),c(2,4)])
#geo_regions$`Geo Code`<-geo_regions$`Geo Code`
colnames(geo_regions)<- c("Geo Regions","Geo Code")

# First, define SDG list
SDG<-(data.frame(c('Sub-Saharan Africa', 'Northern Africa and Western Asia', 'Central and Southern Asia', 'Eastern and South-Eastern Asia', 'Latin America and the Caribbean', 'Oceania', 'Europe and Northern America')))
SDG<-toupper(SDG[,1])
SDG<-data.frame(SDG)

# Let's create a Region/Subregioncolumn for grouping
dt_group1[,16:20] <- NA

colnames(dt_group1)[16:20] <- c("RegionCode","Sub-RegionCode","CountryCode","UNCode", "WBCode")
# Classifying
for(i in 22:283) {
  # this is a region
  rc <- FALSE
  if (dt_group1[i,2] %in% unlist(SDG[,1])){ 
    rc<-TRUE
    regioncode<-(dt_group1[i,4])
    dt_group1[i,16]<- regioncode
    }
  # this is a sub region
  if (sum(unlist(dt_group1[i,6:14])) == 0 & rc == FALSE) { 
    subregioncode<-(dt_group1[i,4])
    dt_group1[i,16]<- regioncode
    dt_group1[i,17] <- subregioncode
  }
  # this is a country
  if (sum(unlist(dt_group1[i,6:14])) >= 1) { 
    dt_group1[i,16] <- regioncode 
    dt_group1[i,17] <- subregioncode
    dt_group1[i,18] <- dt_group1[i,4]
    if (dt_group1[i,6] == TRUE) dt_group1[i,19]<-(un_grp[1,2])
    if (dt_group1[i,7] == TRUE & dt_group1[i,8] == FALSE ) dt_group1[i,19]<-(un_grp[2,2])
    if (dt_group1[i,7] == TRUE & dt_group1[i,8] == TRUE ) dt_group1[i,19]<-(un_grp[3,2])
    if (dt_group1[i,9] == TRUE) dt_group1[i,20]<-(wb_income[1,2])
    if (dt_group1[i,10] == TRUE) dt_group1[i,20]<-(wb_income[2,2])
    if (dt_group1[i,11] == TRUE) dt_group1[i,20]<-(wb_income[3,2])
    if (dt_group1[i,12] == TRUE) dt_group1[i,20]<-(wb_income[4,2])
    if (dt_group1[i,13] == TRUE) dt_group1[i,20]<-(wb_income[5,2])
    if (dt_group1[i,14] == TRUE) dt_group1[i,20]<-(wb_income[6,2])
    
    }
}
dt_group1<-type_convert(dt_group1)

```


# Re-arranging classification and population data and joining datasets

On both datasets, first lines will be deleted given that classification info was retrieved in separate data frames
```{r}
dt_group2<-dt_group1[,-c(1,3,5:15),]
dt_group2<-dt_group2[-c(2,7,14,21),]
dt_group2<-dt_group2[,c(2,1,3:7)]

#Joining country grouping data set into main migration data set
df_comb <-left_join( dt_migr1, dt_group2[,-c(2)], by='Code' )
df_comb <- df_comb[,c(5,1:4,6,242:246,7:241)]
df_comb <- df_comb[,-c(5,6)]

#populatin data set
dt_pop1<-dt_pop
dt_pop1<-rename(dt_pop1,Destination=names(dt_pop1)[3])
dt_pop1<-rename(dt_pop1,Code=names(dt_pop1)[5])
names(dt_pop1)[7:14]<-c(1990,1995,2000,2005,2010,2015,2019,2020)
dt_pop1<-dt_pop1[,-c(6)]
df_comb1<-left_join(df_comb,dt_pop1, by='Code')

head(df_comb,20)

```


# Re-arranging population dataset

```{r}


```


# Exploratory Data Analysis on countries of destination and origin

Data set contains historical data on migration for the years 1990, 1995,2000, 2005,2010, 2015 and 2019. There are many ways these dataset can be slided and diced. 

Quick summary:

```{r}
(df_top<- df_comb %>%
  group_by(Year) %>%
  filter((CountryCode)>0) %>%
  summarize(count=n(), Total=sum(Total, na.rm = TRUE)))
```

Some examples:

Number of international migrants by major area of destination
```{r}

```

International migrants as a percentage of total population by major area of destination
```{r}

```

Twenty countries or areas hosting the largest numbers of international migrants (millions)
```{r}

```

Twenty countries or areas of origin with the largest diaspora populations (millions)
```{r}

```







Goal is to create a visualization output that displays migration flow

```{r}
# location data
df_loc1<-dt_loc
df_loc1<-rename(df_loc1,Destination=names(df_loc1)[2])
df_loc1<-rename(df_loc1,DestLat=names(df_loc1)[3])
df_loc1<-rename(df_loc1,DestLon=names(df_loc1)[4])
# joining migration dataset with location dataset
df_all<-left_join( df_comb, df_loc1, by='Destination' )
df_all<-select(df_all, Code:WBCode, country:DestLon, everything())

# Gathering dataset
df_all2<-gather(df_all, Afghanistan:Zimbabwe, key="Origin", value="TotalOrigin")

# joining migration dataset with country of origin latitude and longitude data
df_loc3<-dt_loc[,-c(1)]
df_loc3<-rename(df_loc3,Origin=names(df_loc3)[1])
df_loc3<-rename(df_loc3,OriginLat=names(df_loc3)[2])
df_loc3<-rename(df_loc3,OriginLon=names(df_loc3)[3])
df_loc4<-left_join(df_all2, df_loc3, by='Origin' )
```


# visualization test

leaflet(df_loc1_2019) %>% 
  addTiles() %>% 
  addCircles(~DestLon , ~DestLat, weight = 1, radius =  ~sqrt(Total)*300)


df_loc1_2019<- df_all %>% 
filter(Year == 1990 & WBCode == 1502)

df_loc2_2019<- df_all2 %>% 
filter(Destination == 'Mauritius' & WBCode == 1502)


leaflet(df_loc1_2019) %>% 
  addTiles() %>% 
  addCircles(weight = 1,
    radius =  ~sqrt(Total)*300)
```



Dendogram

```{r}


# location data
df_loc1<-dt_loc
df_loc1<-rename(df_loc1,Destination=names(df_loc1)[2])
# joining migration dataset with location dataset
df_loc1<-left_join( df_loc1, df_comb, by='Destination' )
# Gathering dataset
df_loc2<-gather(df_loc1, (Afghanistan:Zimbabwe), key="Origin", value="TotalOrigin")
# joining 
df_loc3<-dt_loc
df_loc3<-rename(df_loc3,Origin=names(df_loc3)[2])
df_loc3<-rename(df_loc3,OriginLat=names(df_loc3)[3])
df_loc3<-rename(df_loc3,OriginLon=names(df_loc3)[4])
df_loc4<-left_join( df_loc2, df_loc3[,-c(1)], by='Origin' )

df_loc1_2019<- df_loc1 %>% 
filter(Year == 2019 & WBCode == 1500)

leaflet(df_loc1_2019) %>% 
  addTiles() %>% 
  addCircles(weight = 1,
    radius =  ~sqrt(Total)*300)

# airport locations
air <- read.csv(
  'https://plotly-r.com/data-raw/airport_locations.csv'
)
# flights between airports
flights <- read.csv(
  'https://plotly-r.com/data-raw/flight_paths.csv'
)
flights$id <- seq_len(nrow(flights))

# map projection
geo <- list(
  projection = list(
    type = 'orthographic',
    rotation = list(lon = -100, lat = 40, roll = 0)
  ),
  showland = TRUE,
  landcolor = toRGB("gray95"),
  countrycolor = toRGB("gray80")
)

plot_geo(color = I("red")) %>%
  add_markers(
    data = df_loc1_2019, x = ~longitude y = ~latitude, text = ~Destination,
    size = ~Total, hoverinfo = "text", alpha = 0.5
  ) %>%
  add_segments(
    data = group_by(flights, id),
    x = ~start_lon, xend = ~end_lon,
    y = ~start_lat, yend = ~end_lat,
    alpha = 0.3, size = I(1), hoverinfo = "none"
  ) %>%
  layout(geo = geo, showlegend = FALSE)


  

df_den <- df_
hcd <- as.dendrogram(hc)
```


# Total migration per country of destination are located on the "Destination" horizontal column and contribution for that country of origin

```{r}
dt_main_19 <- filter( dt_main, Year == 2019 )
```

