---
title: "International Migration"
author: "Bruno de Melo"
date: "5/3/2020"
output: html_document
---

# International Migration
Project goal is to analyse international migration based on data obtained on the UN and World Bank data sites.

Data set contains historical data on migration for the years 1990, 1995, 2005, 2015 and 2019. There are many ways these dataset can be slided and diced. We will focus on the top countries of destination and origin.
# Visualization of migration flows over time
# What makes the top 20 destination countries attractive
# Can we predict next country in the club, based on indicators?
# Cluster analysis on World Bank Income group

# Data set-up

```{r}
library(tidyverse)
library(readxl)
library(lubridate)
library(leaflet)
library(plotly)
library(GGally)
library(treemapify)
library(RColorBrewer)
library(geosphere)
library(viridis)
library(patchwork)
library(hrbrthemes)
library(circlize)
library(networkD3)
library(alluvial)
library(treemapify)
library(leaflet.minicharts)

install.packages("leaflet")
install.packages("plotly")
install.packages("GGally")
install.packages("viridis")
install.packages("patchwork")
install.packages("hrbrthemes")
install.packages("circlize")
install.packages("networkD3")
install.packages("alluvial")
install.packages("treemapify")
install.packages("leaflet.minicharts")
install.packages("RColorBrewer")
install.packages("geosphere")

# Data loading and data frame wrangling

# Files location
link_1<-"https://raw.githubusercontent.com/bsvmelo/CUNY/master/FinalProject/undataset.csv"

link_2<-"https://raw.githubusercontent.com/bsvmelo/CUNY/master/FinalProject/ANNEX.csv"

link_3<- xxxxx

link_4<-"https://raw.githubusercontent.com/bsvmelo/CUNY/master/FinalProject/location1.csv"

link_5<-"https://raw.githubusercontent.com/bsvmelo/CUNY/master/FinalProject/population1.csv"

comma<-function(x) format(x, digits=0, big.mark = ",")
perc<-function(x) format(x, digits=2)

#loading data frames

#Contains Destination and Origin information per year
dt_migr<-read_csv(link_1, col_names = FALSE, skip=14, guess_max = 1000, col_types = cols(.default = col_character()),  locale = locale(grouping_mark = ",")) %>% data.frame()
dt_migr1<-dt_migr
# year column set to do col_types = cols(.default = col_character()), glimpse(dt_migr,20)

#Contains UN Development groups and World Bank's Income group classifications of each country 
dt_annex<-read.csv(link_2,header=FALSE, sep=",", stringsAsFactors = FALSE, skip = 15) %>% data.frame()
dt_group1<-dt_annex

#Contains World Bank's indices dataset


#Contains latitute and longitude data for each country
dt_loc<-read_csv(link_4, col_names = TRUE, guess_max = 100, locale = locale(decimal_mark = ".")) %>% data.frame()

#Contains population data for each country
dt_pop<-read_csv(link_5, col_names = TRUE, guess_max = 100, locale = locale(grouping_mark = ",")) %>% data.frame()

```

# Destination and Origin data set
This is the main data set, it contains migration stock from several years for all countries in the world. It also contains info on some country classification.

```{r}
# inspecting data frame
head(dt_migr1,20)

# rows 1 and 2 are the headers, so let's manipulate these rows and transform them into headers
# Let's retain columns 1 to 6 from row 15 and columns 7 to 241 from row 16
dt_migr1[1,c(7:241)]<-dt_migr1[2,c(7:241)]
dt_migr1<-dt_migr1[-c(2),] 
# Renaming headers with row 1 values and removing first row
names(dt_migr1) <- unname(unlist(dt_migr1[1,]))
dt_migr1 <- dt_migr1[-1,]
# converting columns
dt_migr1<-type_convert(dt_migr1)
dt_migr1[,1]<-year(parse_date(as.character(dt_migr1[,1]),"%Y"))
# Renaming column 3, column 6
dt_migr1<-rename(dt_migr1,Destination=names(dt_migr1)[3])
dt_migr1<-rename(dt_migr1,TypeData=names(dt_migr1)[6])

#Dimension and quick visualization of data frame
dim(dt_migr1)
head(dt_migr1,20)

```

# UN Development groups and World Bank's Income group classifications of each country
This is an auxiliary data set that contains country classification by UN Development and World Bank's Income groups.

```{r}
# dt_group1

# inspecting data frame
head(dt_group1,10)
# row 1 is the header, so let's manipulate it transforming it the dataset header
names(dt_group1) <- unname(unlist(dt_group1[1,]))
dt_group1 <- dt_group1[-1,]
# Renaming column 2, column 5
dt_group1<-rename(dt_group1,Region=names(dt_group1)[2])
dt_group1<-rename(dt_group1,TypeData=names(dt_group1)[5])
#dt_group1<-type_convert(dt_group1)
#Dimension and quick visualization of data frame
dim(dt_group1)
head(dt_group1,20)
```

Cross reference is type factor but we need to convert to Logical

```{r}
dt_group1[,c(6:15)] <- ifelse(dt_group1[,c(6:15)] == "Y", TRUE, FALSE)
dt_group1<-type_convert(dt_group1)
```



# UN and World Bank Classifications
There are several classifications listed in the data set. They are defined in the first 20 or so rows. These are the classification / groups:

1: UN development group: More developed, Less developed, least developed and Less developed ex-least
2: World Bank Income groups: High-, Middle-, Upper-Middle-, Lower-Middle-, Low-, No Income
3: Geographic Regions: Africa, Asia, Europe, Latin America & the Caribbean, Northern America, and Oceania.
4: Sustainable Development Goal (SDG) 7 regions:Sub-Saharan Africa, Northern Africa and Western Asia, Central and Southern Asia, Eastern and South-Eastern Asia, Latin America and the Caribbean, Oceania, and Europe and Northern America. These regions are further divided into 22 geographic subregions.

Cross reference is done by classification #1, #2 and 3 above. This will be enhanced with adding these specific codes to countries.  We also need to classify all countries by #4, as this will help with data set containing migration data.

```{r}
# UN development group
un_grp<-data.frame(dt_migr1[c(3:6),c(3,5)])
#un_grp$CountryCode<-as.numeric(un_grp$CountryCode)
colnames(un_grp)<- c("UN Dev Group","UN Dev Code")

# WB development group
wb_income<-data.frame(dt_group1[c(8:13),c(2,4)])
#wb_income$CountryCode<-as.integer(wb_income$CountryCode)
colnames(wb_income)<- c("WB Income","WB Inc Code")
# Geographic Regions
geo_regions<-data.frame(dt_group1[c(15:20),c(2,4)])
#geo_regions$`Geo Code`<-geo_regions$`Geo Code`
colnames(geo_regions)<- c("Geo Regions","Geo Code")

# First, define SDG list
SDG<-(data.frame(c('Sub-Saharan Africa', 'Northern Africa and Western Asia', 'Central and Southern Asia', 'Eastern and South-Eastern Asia', 'Latin America and the Caribbean', 'Oceania', 'Europe and Northern America')))
SDG<-toupper(SDG[,1])
SDG<-data.frame(SDG)
SDG[,2]<-c(947,1833,921,1832,1830,909,1829)
colnames(SDG)[2]<-"SDGCode"

# Let's create a Region/Subregioncolumn for grouping
dt_group1[,16:20] <- NA

colnames(dt_group1)[16:20] <- c("RegionCode","Sub-RegionCode","CountryCode","UNCode", "WBCode")
# Classifying
for(i in 22:283) {
  # this is a region
  rc <- FALSE
  if (dt_group1[i,2] %in% unlist(SDG[,1])){ 
    rc<-TRUE
    regioncode<-(dt_group1[i,4])
    dt_group1[i,16]<- regioncode
    }
  # this is a sub region
  if (sum(unlist(dt_group1[i,6:14])) == 0 & rc == FALSE) { 
    subregioncode<-(dt_group1[i,4])
    dt_group1[i,16]<- regioncode
    dt_group1[i,17] <- subregioncode
  }
  # this is a country
  if (sum(unlist(dt_group1[i,6:14])) >= 1) { 
    dt_group1[i,16] <- regioncode 
    dt_group1[i,17] <- subregioncode
    dt_group1[i,18] <- dt_group1[i,4]
    if (dt_group1[i,6] == TRUE) dt_group1[i,19]<-(un_grp[1,2])
    if (dt_group1[i,7] == TRUE & dt_group1[i,8] == FALSE ) dt_group1[i,19]<-(un_grp[2,2])
    if (dt_group1[i,7] == TRUE & dt_group1[i,8] == TRUE ) dt_group1[i,19]<-(un_grp[3,2])
    if (dt_group1[i,9] == TRUE) dt_group1[i,20]<-(wb_income[1,2])
    if (dt_group1[i,10] == TRUE) dt_group1[i,20]<-(wb_income[2,2])
    if (dt_group1[i,11] == TRUE) dt_group1[i,20]<-(wb_income[3,2])
    if (dt_group1[i,12] == TRUE) dt_group1[i,20]<-(wb_income[4,2])
    if (dt_group1[i,13] == TRUE) dt_group1[i,20]<-(wb_income[5,2])
    if (dt_group1[i,14] == TRUE) dt_group1[i,20]<-(wb_income[6,2])
    
    }
}
dt_group1<-type_convert(dt_group1)

# Summary of WB classification
(dt_group1 %>%
   select(CountryCode, Region, WBCode) %>%
   group_by(WBCode)  %>%
  filter( CountryCode > 0) %>%
  summarize(coun=n()))

```


# Re-arranging classification and population data and joining datasets

On both datasets, first lines will be deleted given that classification info was retrieved in separate data frames
```{r}
dt_group2<-dt_group1[,-c(1,3,5:15),]
dt_group2<-dt_group2[-c(2,7,14,21),]
dt_group2<-dt_group2[,c(2,1,3:7)]

#Joining country grouping data set into main migration data set
df_comb <-left_join( dt_migr1, dt_group2[,-c(2)], by='Code' )
df_comb <- df_comb[,c(5,1:4,6,242:246,7:241)]
df_comb <- df_comb[,-c(5,6)]

df_comb1<-df_comb
df_comb1$key1<-paste(df_comb1$Code,df_comb1$Year)

#populatin data set
dt_pop1<-dt_pop
dt_pop1<-rename(dt_pop1,Destination=names(dt_pop1)[3])
dt_pop1<-rename(dt_pop1,Code=names(dt_pop1)[5])
names(dt_pop1)[7:14]<-c("1990","1995","2000","2005","2010","2015","2019","2020")
dt_pop1<-dt_pop1[,-c(6)]
# Gathering dataset
dt_pop2<-gather(dt_pop1, `1990`,`1995`,`2000`,`2005`,`2010`,`2015`,`2019`,`2020`, key="Year", value="Population")
dt_pop2<-type_convert(dt_pop2)
dt_pop2$key1<-paste(dt_pop2$Code,dt_pop2$Year)

df_comb1<-left_join(df_comb1, dt_pop2[,-c(1:6)], by='key1')
df_comb1<-select(df_comb1, Code:WBCode, Population, everything())
df_comb1$Population<-df_comb1$Population*1000
df_comb1<-rename(df_comb1,TotalMigration=names(df_comb1)[11])

#region dataset - WB codes
df_region<-gather(dt_migr1, Afghanistan:Zimbabwe, key="Origin", value="TotalOrigin")
df_region[,c(12:16)]<-dt_group1[match(df_region[,c(10)],dt_group1$Region),16:20]
df_region[,c(17)]<-dt_group1[match(df_region[,c(16)],dt_group1$Code),2]

colnames(df_region)[(12:17)]<-c("RegionCodeOrigin","Sub-RegionCodeOrigin","CountryCodeOrigin","UNCodeOrigin", "WBCodeOrigin","WBOriginGroup")

df_region<-df_region %>%
  filter(Code %in%  c(1503,1502,1501,1500)) %>%
  group_by(Year, Destination, Code, WBCodeOrigin,WBOriginGroup)%>%
  summarise(total=sum(TotalOrigin, na.rm=TRUE))

colnames(df_region)[(2:6)]<-c("RegionDest","CodeDest","CodeOrigin","RegionOrigin", "TotalMigration")

#Total migration to Region's classified by the World Bank
(df_region %>%
  filter (Year == 2019)  %>%
  group_by(RegionDest)  %>%
  summarize(sum(TotalMigration)))


```


# Exploratory Data Analysis on migration trend on regions and countries of destination and origin

Data set contains historical data on migration for the years 1990, 1995,2000, 2005,2010, 2015 and 2019.  

Here are some hipotheses I would like to test:

1:Find evidence that more developed, wealthier regions or countries attract more migrants. We could also verify whether the converse is also true, meaning that regions or countries which are less developed have more people leaving their borders.

2:In terms of trend, we would like to check that countries becoming weathier over time, also tend to attract more people over time.


First, let's check what's the flow of migrants between countries with more than 1min migrants in 2019.  

```{r}
#dataset set up
df_long<- df_comb1 %>%
  filter((CountryCode)>0 & Year == 2019) %>%
  select(Year, Destination, TotalMigration, CountryCode, Afghanistan:Zimbabwe)
df_long<-gather(df_comb1, Afghanistan:Zimbabwe, key="Origin", value="TotalOrigin")
df_long[,c(17:21)]<-dt_group1[match(df_long[,c(15)],dt_group1$Region),16:20]
df_long<-df_long[,-c(3,12,13,14)]
colnames(df_long)[(13:17)]<-c("RegionCodeOrigin","Sub-RegionCodeOrigin","CountryCodeOrigin","UNCodeOrigin", "WBCodeOrigin")
df_long<- df_long %>%
  filter(CountryCode >0, Year == 2019, TotalMigration>1000000, TotalOrigin>1000000)
df_long[is.na(df_long)] <- 0 
df_long[,c(18:19)]<-df_loc1[match(df_long[,c(3)],df_loc1$Destination),3:4]
df_long[,c(20:21)]<-df_loc1[match(df_long[,c(11)],df_loc1$Destination),3:4]
colnames(df_long)[(18:21)]<-c("DestLat","DestLon","OriginLat","OriginLon")
df_long<-df_long[,c(1:17,21,20,19,18)]
df_long<-df_long[-c(35),]
```

This is an interactive map, showing the main migration routes in 2019.

```{r}
# map projection
flows <- gcIntermediate(df_long[,18:19], df_long[,20:21], sp = TRUE, addStartEnd = TRUE)

flows$counts <- df_long$TotalOrigin/1000000

flows$origins <- df_long$Origin

flows$destinations <- df_long$Destination

hover <- paste0(flows$origins, " to ", 
                flows$destinations, ': ', 
                as.character(flows$counts))

pal <- colorFactor(brewer.pal(4, 'Set2'), flows$origins)

leaflet() %>%
  addProviderTiles('CartoDB.Positron') %>%
  addPolylines(data = flows, weight = ~counts, label = hover, 
               group = ~origins, color = ~pal(origins)) %>%
  addLayersControl(overlayGroups = unique(flows$origins), 
                   options = layersControlOptions(collapsed = FALSE))





```

Below shows the flow of migrants between regions in 2019, as classified by the World Bank.

```{r}
# preparing dataset
data_long <- df_region[,c(1,5,2,6)] %>%
  filter(Year==2019)
data_long<- data_long[,-c(1)]
data_long$RegionOrigin<-str_replace_all(data_long$RegionOrigin,"countries","")
data_long$RegionDest<-str_replace_all(data_long$RegionDest,"countries","")
data_long$RegionOrigin<-str_replace_all(data_long$RegionOrigin,"group","")
data_long$RegionDest<-str_replace_all(data_long$RegionDest,"group","")
data_long$RegionOrigin<-str_replace_all(data_long$RegionOrigin,"available","")
data_long$RegionDest<-str_replace_all(data_long$RegionDest,"availble","")

```

# Plot diagram

```{r}

# parameters
circos.clear()
circos.par(start.degree = -90, gap.degree = 1, track.margin = c(-0.1, 0.1), points.overflow.warning = FALSE)
par(mar = rep(0, 4))

# color palette
mycolor <- viridis(5, alpha = 1, begin = 0, end = 1, option = "D")
mycolor <- as.vector(mycolor[sample(1:5)])
#mycolor <- c("#FDE725FF","#21908CFF","#3B528BFF","#5DC863FF","#440154FF")

# Base plot
chordDiagram(
  x = data_long, 
  grid.col = mycolor,
  transparency = 0.25,
  directional = 1,
  direction.type = c("arrows", "diffHeight"), 
  diffHeight  = -0.04,
  annotationTrack = "grid", 
  annotationTrackHeight = c(0.05, 0.1),
  link.arr.type = "big.arrow", 
  link.sort = TRUE, 
  link.largest.ontop = TRUE)
# Add text and axis

legend("bottomleft", pch = 1, legend = "Migration flow - 2019")
circos.trackPlotRegion(
  track.index = 1, 
  bg.border = NA, 
  panel.fun = function(x, y) {
    
    xlim = get.cell.meta.data("xlim")
    sector.index = get.cell.meta.data("sector.index")
    
    # Add names to the sector. 
    circos.text(
      x = mean(xlim), 
      y = 2.5, 
      labels = sector.index, 
      facing = "bending",
      cex = 0.8
      )
  }
)
```

As can be see, High-Income countries received the highest numbers of migrants, including from within its sector migration. Upper-middle-income group seems to have more migration than low-income group.

In aggregate, international migrants as a percentage of total population does not seem to be a high number. On average around 3% over the years.

```{r}
(df_1<- df_comb1 %>%
  group_by(Year) %>%
  filter((CountryCode)>0) %>%
  summarize(count=n(), TotalMigration=sum(TotalMigration, na.rm = TRUE), Population=sum(Population, na.rm = TRUE), MigrPop=sum(TotalMigration) / sum(Population, na.rm=TRUE)))


```

Exploring trends by different classifications. 

Let's show graphically the international migrants as a percentage of total population over time in order to check trends.

1:Sustainable Development Goal (SDG)
Let's analyse the major areas of migration destination by SDG region. Plot shows the number of international migrants by area of destination.

```{r}
# function to label the facet wrap
descr<-function(labval) {
  labval<-SDG[match(labval,SDG$SDGCode),1]
}

(df_2<- df_comb1 %>%
  group_by(Year, RegionCode) %>%
  filter((CountryCode)>0) %>%
  summarize(No_Countries=n(), TotalMigration=sum(TotalMigration, na.rm = TRUE)/1000000)  %>%
  ggplot(aes(Year, TotalMigration, color = No_Countries))+
  geom_line(alpha =1/3, size = 1) +
  facet_wrap(~RegionCode, labeller=labeller(RegionCode = descr))+ 
      labs(title = "Migration Trends over time",
       subtitle = "(by Regions defined by the UN Sustainable Development Goals)",
       y = "Migrants in mn", x = "Year")+
    theme(strip.text = element_text(size=6, color="darkblue"))
  
  )
```

Major area of destination is Europe and Northern America, where most of the world's wealth is concentrated. Second largest area of destination is Northern Africa and Western Asia, where the high number of migrants could be associated with wealth driven by the oil-producing countries (and Israel) but also by geopolitical reasons, like wars and forced migration. In this group we find countries like Syria, Yemen, Turkey, and Iraq.

In terms of trends, migration has increased over time in most regions.

Let's check the number of migrants relative to the region total population.

```{r}
# plot 
# function to label the facet wrap
descr<-function(labval) {
  labval<-SDG[match(labval,SDG$SDGCode),1]
}
(df_2<- df_comb1  %>%
  group_by(Year, RegionCode) %>%
  filter((CountryCode)>0) %>%
  summarize(No_Countries=n(), TotalMigration=sum(TotalMigration, na.rm = TRUE), Population=sum(Population, na.rm = TRUE), `%Migration`=sum(TotalMigration) / sum(Population, na.rm=TRUE))  %>%
  ggplot(aes(Year, `%Migration`, color = No_Countries))+
  geom_line(alpha =1/3, size = 1) +
  facet_wrap(~RegionCode, labeller=labeller(RegionCode = descr))+ 
      labs(title = "Migration Trends as a Percentage of population",
       subtitle = "(by Regions defined by the UN Sustainable Development Goals)",
       y = "% of Migrants", x = "Year")+
    theme(strip.text = element_text(size=6, color="darkblue"))
  
  )
```

Similarly to the previous charts, migrant stock relative to the total population is very relevant in Oceania, Europe/Northern America and in Northern Africa. As observed before, it seems it is related to wealth and to other forces.

In terms of trend, migration seems to be increasing in these three regions but it is reasonably stable in the other regions. 

There is some evidence in these charts to assume that migration is driven but both wealth and geopolitical reasons, based on geography only.

2:World Bank Income classification
The World Bank classifies the world's economies into four income groups — high, upper-middle, lower-middle, and low. They base this assignment on Gross National Income (GNI) per capita (current US$) calculated using the Atlas method. 

```{r}
# function to label the facet wrap
descr<-function(labval) {
  labval<-wb_income[match(labval,wb_income$`WB Inc Code`),1]
}
# plot 
(df_2<- df_comb1 %>%
  group_by(Year, WBCode) %>%
  filter((CountryCode)>0) %>%
  summarize(No_Countries=n(), TotalMigration=sum(TotalMigration, na.rm = TRUE), Population=sum(Population, na.rm = TRUE), `%Migration`=sum(TotalMigration) / sum(Population, na.rm=TRUE))  %>%
  ggplot(aes(Year, `%Migration`, color = No_Countries))+
  geom_line(alpha =1/3) +
  facet_wrap(~WBCode, labeller=labeller(WBCode = descr))+
    labs(title = "Migration Trends as a Percentage of population",
       subtitle = "(by Regions defined by the World Bank Income classification)",
       y = "% of Migrants", x = "Year")+
    theme(strip.text = element_text(size=8, color="darkblue")))

```

As evidenced before, high- and upper-middle-income countries are the groups attracting more migrants over time. Despite the fact that the no-income group has the highest percentage, we cannot draw any meaning conclusions for it as is classified in the no income group.

# Countries
Let's analyse the proportion that each country hosts migrants in relation to the total migration number.

```{r}
df_perc<-df_comb1
df_perc <- df_perc  %>%
 filter((CountryCode)>0 & Year == 2019) %>%
 select(Destination, TotalMigration, Population) %>%
 mutate(r=rank(desc(TotalMigration))) %>%
mutate(TotalMigration = TotalMigration/1000000, Population = Population / 1000000)  %>%
 arrange(desc(TotalMigration))%>% 
 mutate(Cumul = cumsum(TotalMigration)/sum(TotalMigration)*100) 

ggplot(df_perc, aes(x=r, y=Cumul)) +
    geom_point(alpha=0.7) +   labs(title = "Migration share by country",
        y = "% of total migration", x = "Number of countries")+
    theme(strip.text = element_text(size=8, color="darkblue"))

head(df_perc, 20)
```

It can be seen that 20 countries hosts around 2/3 of all migrants in the world. Let's analyse in more detail these twenty countries.

```{r}
df_20<- df_comb1 %>%
  filter((CountryCode)>0 & Year == 2019) %>%
  select(Year, Destination, TotalMigration, CountryCode, WBCode) %>%
  mutate(r=rank(desc(TotalMigration)), TotalMigration = TotalMigration/1000000) %>%
  filter(r<=20)%>%
   arrange(Year, desc(TotalMigration))

ggplot(df_20, 
       aes(fill = Destination, 
           area = TotalMigration, label = Destination)) +
  geom_treemap() + 
geom_treemap_text(colour = "white", 
                    place = "centre") +
  labs(title = "Top 20 hosting countries in 2019") +
  theme(legend.position = "none")


```

The USA is by far the most attractive country, representing 19% of all migrant destination in 2019. This could be annecdotally explained by the fact it is the wealthiest countries in the world and maybe also by the fact that it always had a big migrant population. The others countries are either wealthy or are located in problematic areas such as Turkey, Jordan.

Let's visualize the biggest migration flows between the US and its top migrantion source. (greater than 1mn of migrants).

```{r}

#dataset
df_20<- df_comb1 %>%
  filter((CountryCode)>0 & Year == 2019) %>%
  select(Year, Destination, TotalMigration, CountryCode, Afghanistan:Zimbabwe) %>%
  mutate(r=rank(desc(TotalMigration)), TotalMigration = TotalMigration/1000000) %>%
  filter(TotalMigration>1) %>%
   arrange(Year, desc(TotalMigration))

df_20_long<-gather(df_20, Afghanistan:Zimbabwe, key="Origin", value="TotalOrigin")
df_20_long<-mutate(df_20_long,TotalOrigin=TotalOrigin/1000000)
df_20_long[is.na(df_20_long)] <- 0  
df_20_long<-df_20_long[,c(2,4,6,7)]
df_20_long<-df_20_long%>%
  filter(CountryCode ==840)%>%
  filter(TotalOrigin>1)
df_20_long<-df_20_long[,c(3,1,4)]


```

#Plot

```{r}
# parameters
circos.clear()
circos.par(start.degree = -90, gap.degree = 1, track.margin = c(-0.1, 0.1), points.overflow.warning = FALSE)
par(mar = rep(0, 4))

# color palette
mycolor <- viridis(12, alpha = 1, begin = 0, end = 1, option = "D")
mycolor <- as.vector(mycolor[sample(1:12)])
#mycolor <- c("#FDE725FF","#21908CFF","#3B528BFF","#5DC863FF","#440154FF")

# Base plot
chordDiagram(
  x = df_20_long, 
  grid.col = mycolor,
  transparency = 0.25,
  directional = 1,
  direction.type = c("arrows", "diffHeight"), 
  diffHeight  = -0.04,
  annotationTrack = "grid", 
  annotationTrackHeight = c(0.05, 0.1),
  link.arr.type = "big.arrow", 
  link.sort = TRUE, 
  link.largest.ontop = TRUE)
# Add text and axis

legend("bottomleft", pch = 1, legend = "Migration flow to USA - 2019")
circos.trackPlotRegion(
  track.index = 1, 
  bg.border = NA, 
  panel.fun = function(x, y) {
    
    xlim = get.cell.meta.data("xlim")
    sector.index = get.cell.meta.data("sector.index")
    
    # Add names to the sector. 
    circos.text(
      x = mean(xlim), 
      y = 2.5, 
      labels = sector.index, 
      facing = "downward",
      cex = 0.8
      )
  }
)
```

Biggest migrants are from Mexico, China and India. This could be driven by not only economic reasons but by family ties, for example.

Let's analyse the flow to Turkey.

```{r}

#dataset
df_20<- df_comb1 %>%
  filter((CountryCode)>0 & Year == 2019) %>%
  select(Year, Destination, TotalMigration, CountryCode, Afghanistan:Zimbabwe) %>%
  mutate(r=rank(desc(TotalMigration)), TotalMigration = TotalMigration/1000000) %>%
  filter(TotalMigration>1) %>%
   arrange(Year, desc(TotalMigration))

df_t_long<-gather(df_20, Afghanistan:Zimbabwe, key="Origin", value="TotalOrigin")
df_t_long<-mutate(df_t_long,TotalOrigin=TotalOrigin/1000000)
df_t_long[is.na(df_t_long)] <- 0  
df_t_long<-df_t_long[,c(2,4,6,7)]
df_t_long<-df_t_long%>%
  filter(CountryCode ==792, TotalOrigin>0.05)
df_t_long<-df_t_long[,c(3,1,4)]

```

#Plot

```{r}
# parameters
circos.clear()
circos.par(start.degree = 90, gap.degree = 1, track.margin = c(-0.1, 0.1), points.overflow.warning = FALSE)
par(mar = rep(0, 4))

# color palette
mycolor <- viridis(8, alpha = 1, begin = 0, end = 1, option = "D")
mycolor <- mycolor[sample(1:8)]

# Base plot
chordDiagram(
  x = df_t_long, 
  grid.col = mycolor,
  transparency = 0.25,
  directional = 1,
  direction.type = c("arrows", "diffHeight"), 
  diffHeight  = -0.04,
  annotationTrack = "grid", 
  annotationTrackHeight = c(0.05, 0.1),
  link.arr.type = "big.arrow", 
  link.sort = TRUE, 
  link.largest.ontop = TRUE)
# Add text and axis

legend("bottomleft", pch = 1, legend = "Migration flow to Turkey - 2019")
circos.trackPlotRegion(
  track.index = 1, 
  bg.border = NA, 
  panel.fun = function(x, y) {
    
    xlim = get.cell.meta.data("xlim")
    sector.index = get.cell.meta.data("sector.index")
    
    # Add names to the sector. “inside”, “outside”, “reverse.clockwise”, “clockwise”, “downward”, “bending”, “bending.inside”, “bending.outside”
    circos.text(
      x = mean(xlim), 
      y = 2.5, 
      labels = sector.index, 
      facing = "downward",
      cex = 0.8
      )
  }
)


```

Biggest flow to Turkey is from Syria due to recento geopolitical reasons. There's also a big migration from Bulgaria, which does not seem obvious.



```{r}
df_long<- df_comb1 %>%
  filter((CountryCode)>0 & Year == 2019) %>%
  select(Year, Destination, TotalMigration, CountryCode, Afghanistan:Zimbabwe)
df_long<-gather(df_comb1, Afghanistan:Zimbabwe, key="Origin", value="TotalOrigin")
df_long[,c(17:21)]<-dt_group1[match(df_long[,c(15)],dt_group1$Region),16:20]
df_long<-df_long[,-c(3,12,13,14)]
colnames(df_long)[(13:17)]<-c("RegionCodeOrigin","Sub-RegionCodeOrigin","CountryCodeOrigin","UNCodeOrigin", "WBCodeOrigin")
df_long<- df_long %>%
  filter(CountryCode >0, Year == 2019, TotalMigration>1000000, TotalOrigin>1000000)
df_long[is.na(df_long)] <- 0 
df_long[,c(18:19)]<-df_loc1[match(df_long[,c(3)],df_loc1$Destination),3:4]
df_long[,c(20:21)]<-df_loc1[match(df_long[,c(11)],df_loc1$Destination),3:4]
colnames(df_long)[(18:21)]<-c("DestLat","DestLon","OriginLat","OriginLon")
df_long<-df_long[,c(1:17,21,20,19,18)]
df_long<-df_long[-c(35),]
```

```{r}

# map projection
flows <- gcIntermediate(df_long[,18:19], df_long[,20:21], sp = TRUE, addStartEnd = TRUE)

flows$counts <- df_long$TotalOrigin/1000000

flows$origins <- df_long$Origin

flows$destinations <- df_long$Destination

hover <- paste0(flows$origins, " to ", 
                flows$destinations, ': ', 
                as.character(flows$counts))

pal <- colorFactor(brewer.pal(4, 'Set2'), flows$origins)

leaflet() %>%
  addProviderTiles('CartoDB.Positron') %>%
  addPolylines(data = flows, weight = ~counts, label = hover, 
               group = ~origins, color = ~pal(origins)) %>%
  addLayersControl(overlayGroups = unique(flows$origins), 
                   options = layersControlOptions(collapsed = FALSE))



leaflet(df_long) %>% 
  addTiles() %>% 
  addCircles(lat= ~DestLat, lng = ~DestLon, weight = 1, radius =  ~sqrt(TotalMigration)*100) %>% 
   # addLegend("bottomright", colors= c("#ffa500", "#13ED3F"), labels=df_long, title="Coffee places") %>%
  addFlows(
    df_long$OriginLon, df_long$OriginLat, df_long$DestLon, df_long$DestLat,
    flow = df_long$TotalOrigin,
    time = df_long$Year,
      opacity = 0.5,
  dir = 0,
 popup = popupArgs(labels = "Flow"),
 # maxFlow = max(abs(flow)),
  minThickness = 1,
  maxThickness = 20
    
  )



```


###






















# location data
df_loc1<-dt_loc
df_loc1<-rename(df_loc1,Destination=names(df_loc1)[2])
df_loc1<-rename(df_loc1,DestLat=names(df_loc1)[3])
df_loc1<-rename(df_loc1,DestLon=names(df_loc1)[4])
# joining migration dataset with location dataset
df_all<-left_join( df_comb, df_loc1, by='Destination' )
df_all<-select(df_all, Code:WBCode, country:DestLon, everything())

# Gathering dataset
df_all2<-gather(df_all, Afghanistan:Zimbabwe, key="Origin", value="TotalOrigin")

# joining migration dataset with country of origin latitude and longitude data
df_loc3<-dt_loc[,-c(1)]
df_loc3<-rename(df_loc3,Origin=names(df_loc3)[1])
df_loc3<-rename(df_loc3,OriginLat=names(df_loc3)[2])
df_loc3<-rename(df_loc3,OriginLon=names(df_loc3)[3])
df_loc4<-left_join(df_all2, df_loc3, by='Origin' )

df_2019<- df_loc4 %>% 
filter(Year == 2019 & (CountryCode)>0 & Destination == "Italy")

# map projection
geo <- list(
  projection = list(
    type = 'azimuthal equal area'
    ),
  showland = TRUE,
  landcolor = toRGB("gray95"),
  countrycolor = toRGB("gray80")
)
# plot
plot_geo(color = I("red")) %>%
  add_markers(
    data = df_2019, x = ~DestLon,y = ~DestLat, text = ~Origin,
    size = ~TotalOrigin*3, hoverinfo = "text", alpha = 0.5
  ) %>%
  add_segments(
    data = group_by(df_2019, CountryCode),
    x = ~df_2019$OriginLon, xend = ~df_2019$DestLon,
    y = ~df_2019$OriginLat, yend = ~df_2019$DestLat,
    alpha = 0.3, size = I(1), hoverinfo = "none"
  ) %>%
  layout(geo = geo, showlegend = FALSE)


mutate(r=rank(desc(TotalMigration)))
```


# visualization test
```{r}
df_loc1_2019<- df_loc1 %>% 
filter(Year == 2019 & WBCode == 1500)

leaflet(df_loc1_2019) %>% 
  addTiles() %>% 
  addCircles(weight = 1,
    radius =  ~sqrt(Total)*300)

# airport locations
air <- read.csv(
  'https://plotly-r.com/data-raw/airport_locations.csv'
)
# flights between airports
flights <- read.csv(
  'https://plotly-r.com/data-raw/flight_paths.csv'
)
flights$id <- seq_len(nrow(flights))

# map projection
geo <- list(
  projection = list(
    type = 'azimuthal equal area',
    ),
  showland = TRUE,
  landcolor = toRGB("gray95"),
  countrycolor = toRGB("gray80")
)

plot_geo(color = I("red")) %>%
  add_markers(
    data = df_loc1_2019, x = ~longitude y = ~latitude, text = ~Destination,
    size = ~Total, hoverinfo = "text", alpha = 0.5
  ) %>%
  add_segments(
    data = group_by(flights, id),
    x = ~start_lon, xend = ~end_lon,
    y = ~start_lat, yend = ~end_lat,
    alpha = 0.3, size = I(1), hoverinfo = "none"
  ) %>%
  layout(geo = geo, showlegend = FALSE)


leaflet(df_loc1_2019) %>% 
  addTiles() %>% 
  addCircles(~DestLon , ~DestLat, weight = 1, radius =  ~sqrt(Total)*300)


df_loc1_2019<- df_all %>% 
filter(Year == 1990 & WBCode == 1502)

df_loc2_2019<- df_all2 %>% 
filter(Destination == 'Mauritius' & WBCode == 1502)


leaflet(df_loc1_2019) %>% 
  addTiles() %>% 
  addCircles(weight = 1,
    radius =  ~sqrt(Total)*300)
```




```




df_4<-df_4[,-c(5)]

# top 20 data set over the years
df_3<- df_comb1 %>%
  group_by(Year) %>%
  filter((CountryCode)>0) %>%
  select(Year, Destination, TotalMigration, CountryCode) %>%
  mutate(r=rank(desc(TotalMigration))) %>%
  filter(r<=20)%>%
  arrange(Year, desc(TotalMigration))

df_3<-df_3[,-c(5)]

# top 20 in 2019, this to be used to track these countries total migration since 1990
df_4<- df_3 %>%
  filter(Year == 2019)
df_4<-df_4[,-c(5)]

df_5<-df_comb1 %>%
  filter(CountryCode %in%df_4$CountryCode) %>%
  select(Year, Destination, TotalMigration, CountryCode)
#merging and spreading top 20 in 2019 with all top 20 since 1990
df_6<-full_join(df_5,df_3)
df_6[,c(3)]<-df_6[,c(3)]/1000000
# Excluding USA
#df_6<- df_6[,-c(4)] %>%
#filter(Destination != "United States of America")

df_6<-spread(df_6, key=Year, value = TotalMigration)
(ggparcoord(df_6, columns = 2:8, groupColumn = 1, scale="globalminmax", alphaLines = 0.5, title = "Countries hosting the largest numbers of migrants") + 
 theme(plot.title = element_text(size=10)) + ylab("Migrants in mn"))

df_7<-df_comb1 %>%
  filter(CountryCode %in%df_4$CountryCode) %>%
  select(Year, Destination, TotalMigration, CountryCode)
#merging and spreading top 20 in 2019 with all top 20 since 1990
df_7<-full_join(df_5,df_3)

 df_7 %>% 
  mutate(TotalMigration = TotalMigration/1000000)  %>%
   ggplot(aes(Year, TotalMigration))+
  geom_line(alpha =1/3) +
  facet_wrap(~Destination)+
    labs(title = "Migration Trends as a Percentage of population",
       subtitle = "(by Regions defined by the World Bank Income classification)",
       y = "% of Migrants", x = "Year")+
    theme(strip.text = element_text(size=8, color="darkblue"))

Let's analyse the twenty countries or areas of origin with the largest diaspora populations.


```{r}
df_perc1<-df_all2
df_perc1 <- df_perc1  %>%
 filter((CountryCode)>0 & Year == 2019 &!is.na(TotalOrigin)) %>%
 select(Origin, TotalOrigin) %>%
group_by(Origin)  %>%
nest()

df_perc1$total<-rowSums(do.call(cbind, do.call(c, df_perc1$data)))
xxx<-colSums(matrix(unlist(df_perc1$data), ncol=1, byrow=TRUE))
df_perc1 %>% flatten %>% as.data.frame %>% rowSums

df_perc1$total<-sum(unlist(df_perc1$data), na.rm = TRUE)
  summarise(t=sum(TotalOrigin))
  mutate(t=sum(TotalOrigin, na.rm=TRUE)) %>%


    mutate(r=rank(desc(TotalOrigin))) %>%
mutate(TotalOrigin = TotalOrigin/1000000)  %>%
 arrange(desc(TotalOrigin))%>% 
 mutate(Cumul = cumsum(TotalOrigin)/sum(TotalOrigin)*100) 

ggplot(df_perc, aes(x=r, y=Cumul)) +
    geom_point(alpha=0.7) +   labs(title = "Migration share by country",
        y = "% of total migration", x = "Number of countries")+
    theme(strip.text = element_text(size=8, color="darkblue"))

head(df_perc, 20)






 
```

Twenty countries or areas of origin with the largest diaspora populations (millions)
```{r}

```







Goal is to create a visualization output that displays migration flow

```{r}
# location data
df_loc1<-dt_loc
df_loc1<-rename(df_loc1,Destination=names(df_loc1)[2])
df_loc1<-rename(df_loc1,DestLat=names(df_loc1)[3])
df_loc1<-rename(df_loc1,DestLon=names(df_loc1)[4])
# joining migration dataset with location dataset
df_all<-left_join( df_comb, df_loc1, by='Destination' )
df_all<-select(df_all, Code:WBCode, country:DestLon, everything())

# Gathering dataset
df_all2<-gather(df_all, Afghanistan:Zimbabwe, key="Origin", value="TotalOrigin")

# joining migration dataset with country of origin latitude and longitude data
df_loc3<-dt_loc[,-c(1)]
df_loc3<-rename(df_loc3,Origin=names(df_loc3)[1])
df_loc3<-rename(df_loc3,OriginLat=names(df_loc3)[2])
df_loc3<-rename(df_loc3,OriginLon=names(df_loc3)[3])
df_loc4<-left_join(df_all2, df_loc3, by='Origin' )
```


# visualization test

leaflet(df_loc1_2019) %>% 
  addTiles() %>% 
  addCircles(~DestLon , ~DestLat, weight = 1, radius =  ~sqrt(Total)*300)


df_loc1_2019<- df_all %>% 
filter(Year == 1990 & WBCode == 1502)

df_loc2_2019<- df_all2 %>% 
filter(Destination == 'Mauritius' & WBCode == 1502)


leaflet(df_loc1_2019) %>% 
  addTiles() %>% 
  addCircles(weight = 1,
    radius =  ~sqrt(Total)*300)
```



Dendogram

```{r}


# location data
df_loc1<-dt_loc
df_loc1<-rename(df_loc1,Destination=names(df_loc1)[2])
# joining migration dataset with location dataset
df_loc1<-left_join( df_loc1, df_comb, by='Destination' )
# Gathering dataset
df_loc2<-gather(df_loc1, (Afghanistan:Zimbabwe), key="Origin", value="TotalOrigin")
# joining 
df_loc3<-dt_loc
df_loc3<-rename(df_loc3,Origin=names(df_loc3)[2])
df_loc3<-rename(df_loc3,OriginLat=names(df_loc3)[3])
df_loc3<-rename(df_loc3,OriginLon=names(df_loc3)[4])
df_loc4<-left_join( df_loc2, df_loc3[,-c(1)], by='Origin' )

df_loc1_2019<- df_loc1 %>% 
filter(Year == 2019 & WBCode == 1500)

leaflet(df_loc1_2019) %>% 
  addTiles() %>% 
  addCircles(weight = 1,
    radius =  ~sqrt(Total)*300)

# airport locations
air <- read.csv(
  'https://plotly-r.com/data-raw/airport_locations.csv'
)
# flights between airports
flights <- read.csv(
  'https://plotly-r.com/data-raw/flight_paths.csv'
)
flights$id <- seq_len(nrow(flights))

# map projection
geo <- list(
  projection = list(
    type = 'orthographic',
    rotation = list(lon = -100, lat = 40, roll = 0)
  ),
  showland = TRUE,
  landcolor = toRGB("gray95"),
  countrycolor = toRGB("gray80")
)

plot_geo(color = I("red")) %>%
  add_markers(
    data = df_loc1_2019, x = ~longitude y = ~latitude, text = ~Destination,
    size = ~Total, hoverinfo = "text", alpha = 0.5
  ) %>%
  add_segments(
    data = group_by(flights, id),
    x = ~start_lon, xend = ~end_lon,
    y = ~start_lat, yend = ~end_lat,
    alpha = 0.3, size = I(1), hoverinfo = "none"
  ) %>%
  layout(geo = geo, showlegend = FALSE)


  

df_den <- df_
hcd <- as.dendrogram(hc)
```


# Total migration per country of destination are located on the "Destination" horizontal column and contribution for that country of origin

```{r}
data <- read.table("https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/13_AdjacencyDirectedWeighted.csv", header=TRUE)
colnames(data) <- c("Africa", "East Asia", "Europe", "Latin Ame.",   "North Ame.",   "Oceania", "South Asia", "South East Asia", "Soviet Union", "West.Asia")
rownames(data) <- colnames(data)
data_long <- data %>%
  rownames_to_column %>%
  gather(key = 'key', value = 'value', -rowname)

data_long <- df_loc4%>%
  filter(CountryCode>0, Year==2019, TotalOrigin>0)%>%
select(Origin, Destination,TotalOrigin)

# parameters
circos.clear()
circos.par(start.degree = 90, gap.degree = 4, track.margin = c(-0.1, 0.1), points.overflow.warning = FALSE)
par(mar = rep(0, 4))

# color palette
mycolor <- viridis(10, alpha = 1, begin = 0, end = 1, option = "D")
mycolor <- mycolor[sample(1:5)]

# Base plot
chordDiagram(
  x = data_long, 
  
  transparency = 0.25,
  directional = 1,
  direction.type = c("arrows", "diffHeight"), 
  diffHeight  = -0.04,
  annotationTrack = "grid", 
  annotationTrackHeight = c(0.05, 0.1),
  link.arr.type = "big.arrow", 
  link.sort = TRUE, 
  link.largest.ontop = TRUE)

# Add text and axis
circos.trackPlotRegion(
  track.index = 1, 
  bg.border = NA, 
  panel.fun = function(x, y) {
    
    xlim = get.cell.meta.data("xlim")
    sector.index = get.cell.meta.data("sector.index")
    
    # Add names to the sector. 
    circos.text(
      x = mean(xlim), 
      y = 3.2, 
      labels = sector.index, 
      facing = "bending", 
      cex = 0.8
      )

    # Add graduation on axis
   # circos.axis(
  #    h = "top", 
   #   major.at = seq(from = 0, to = xlim[2], by = ifelse(test = xlim[2]>10, yes = 2, no = 1)), 
  #    minor.ticks = 1, 
  #    major.tick.percentage = 0.5,
   #   labels.niceFacing = FALSE)
  }
)

# parameters
circos.clear()
circos.par(start.degree = 90, gap.degree = 1, track.margin = c(-0.1, 0.1), points.overflow.warning = FALSE)
par(mar = rep(0, 4))


# Base plot
chordDiagram(
  x = data_long, 
  transparency = 0.25,
  directional = 1,
  direction.type = c("arrows", "diffHeight"), 
  diffHeight  = -0.04,
  annotationTrack = "grid", 
  annotationTrackHeight = c(0.05, 0.1),
  link.arr.type = "big.arrow", 
  link.sort = TRUE, 
  link.largest.ontop = TRUE)

```








